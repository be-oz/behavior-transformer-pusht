# Behavior Transformer for Robotic Manipulation (PushT)

## Overview

This project implements a lightweight behavior cloning (BC) pipeline for robotic manipulation on the `PushT-v0` environment from the [LeRobot](https://github.com/huggingface/lerobot) benchmark suite. The goal is to learn a performant policy from offline expert demonstrations using a Transformer encoder. The model learns a discretized coarse action and a residual fine correction for accurate behavior imitation.

**Project Title:** Behavior Transformer for Robotic Manipulation  
**Environment:** PushT-v0  
**Observation:** 2D Agent Position (`[x, y]`)  
**Approach:** Discretized + Residual Behavior Cloning

---

## Directory Structure

```
pusht/
├── expert_data/
│   ├── expert_dataset.npy           # Expert (state, action) episodes
│   ├── pusht_real_trajectories.npy  # Raw collected trajectories
│   ├── expert_trajectories.npy      # Filtered high-quality demonstrations
│   ├── action_codebook.pt           # KMeans-learned coarse action bins
├── train_transformer.py             # Trains Transformer BC model
├── run_kmeans.py                    # Fits codebook using KMeans
├── generate_transformer_dataset.py  # Generates (obs, bin, residual) pairs
├── my_policy.py                     # Inference-time policy wrapper
├── run_my_policy_eval.py            # Runs evaluation & saves rollout video
├── visualize.py                     # Optional: visualizes codebook/actions
├── outputs/
│   └── my_policy_eval.mp4           # Video generated by rollout
├── README.md                        # This file
```

---

## Setup Instructions

### Environment Setup

Requires Python 3.10+ and PyTorch ≥ 2.0.

Install with pip:

```bash
pip install -r requirements.txt
```

Or use Conda:

```bash
conda create -n lerobot python=3.10
conda activate lerobot
pip install -e git+https://github.com/huggingface/lerobot.git@c7c3b47#egg=lerobot
pip install -r requirements.txt
```

---

## Training Pipeline

### Step 1: Generate Transformer Dataset

```bash
python generate_transformer_dataset.py
```

- Loads `expert_dataset.npy`
- Computes bin indices via KMeans and residual vectors
- Outputs `transformer_dataset.npy`

### Step 2: Fit KMeans Codebook

```bash
python run_kmeans.py
```

- Learns `NUM_BINS=32` coarse action clusters
- Saves to `expert_data/action_codebook.pt`

### Step 3: Train Transformer BC Model

```bash
python train_transformer.py
```

- Inputs: 2D agent position
- Outputs: coarse bin logits + residual correction
- Losses: CrossEntropy + MSE

---

## Inference & Evaluation

Run a full rollout and render a video:

```bash
python run_my_policy_eval.py
```

- Loads model + codebook
- Runs environment with predicted actions
- Outputs:
  - Final reward
  - `outputs/my_policy_eval.mp4` video

---

## Design Highlights

| Feature           | Description                                   |
|-------------------|-----------------------------------------------|
| Input             | 2D agent position (no image or object info)   |
| Model             | 1-layer Transformer encoder                   |
| Codebook          | Learned using KMeans on expert actions        |
| Prediction        | Coarse bin + residual vector                  |
| Postprocessing    | Clamping for stability and safety             |
| Modularity        | All components are standalone and reusable    |

---

## Results (Sample)

| Epoch | Classification Loss | Regression Loss |
|-------|---------------------|------------------|
|   1   | 0.960               | 0.033            |
|   5   | 0.222               | 0.014            |
|  10   | 0.184               | 0.0055           |

**Rollout reward (example):** `0.0`  
Performance may improve with richer state input or normalization.

---

## Potential Improvements

- Extend input to full 5D state (agent + object)
- Add normalization to inputs
- Use LR warm-up and cosine decay
- Add regularization/dropout
- Replace 2D input with vision encoder for image-based BC
- Ablation study: bins only vs residual only vs both

---

## Visualization (Optional)

To plot codebook and residuals:

```bash
python visualize.py
```

---

## License

This project inherits the Apache 2.0 license from the [LeRobot](https://github.com/huggingface/lerobot) framework.

---

## Contact

For questions or feedback, please open an issue or pull request on GitHub.
